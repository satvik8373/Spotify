<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Audio Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #121212;
            color: white;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #1ed760;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .test-instructions {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .success {
            color: #1DB954;
        }
        .error {
            color: #ff4444;
        }
    </style>
</head>
<body>
    <h1>üéµ Background Audio Test</h1>
    
    <div class="test-instructions">
        <h3>Test Instructions:</h3>
        <ol>
            <li>Click "Start Audio" to begin playback</li>
            <li><strong>iOS Users:</strong> Ensure you're not in Low Power Mode</li>
            <li>Turn off your screen or lock your device</li>
            <li>Audio should continue playing in background</li>
            <li><strong>iOS:</strong> Use Control Center or Lock Screen controls</li>
            <li>Turn screen back on - audio should still be playing</li>
        </ol>
        <div style="background: #2a2a2a; padding: 10px; border-radius: 6px; margin-top: 10px;">
            <strong>iOS Specific Notes:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Background audio works best when app is added to Home Screen (PWA)</li>
                <li>Disable Low Power Mode for best results</li>
                <li>Use Control Center or Lock Screen controls to test</li>
                <li>May require keeping app in foreground initially</li>
            </ul>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn">Start Audio</button>
        <button id="pauseBtn" disabled>Pause Audio</button>
        <button id="stopBtn" disabled>Stop Audio</button>
    </div>

    <div class="status">
        <div><strong>Platform:</strong> <span id="platformStatus">Detecting...</span></div>
        <div><strong>Status:</strong> <span id="status">Ready</span></div>
        <div><strong>Wake Lock:</strong> <span id="wakeLockStatus">Not Active</span></div>
        <div><strong>Background Manager:</strong> <span id="backgroundStatus">Not Active</span></div>
    </div>

    <audio id="testAudio" preload="metadata"></audio>

    <script>
        // iOS-Specific Background Audio Manager (research-based)
        class IOSTestBackgroundAudioManager {
            constructor() {
                this.audio = null;
                this.isPlaying = false;
                this.audioContext = null;
                this.sourceNode = null;
                this.gainNode = null;
                this.silentBuffer = null;
                this.silentSource = null;
                this.keepAliveInterval = null;
            }

            async initialize(audioElement) {
                this.audio = audioElement;
                this.setupIOSAudioElement();
                await this.initializeAudioContext();
                this.setupIOSEventListeners();
                await this.createSilentBuffer();
                this.updateStatus('backgroundStatus', 'iOS Manager Initialized', 'success');
            }

            setupIOSAudioElement() {
                if (!this.audio) return;

                console.log('üçé Configuring iOS-specific audio element');

                // Essential iOS attributes
                this.audio.setAttribute('playsinline', 'true');
                this.audio.setAttribute('webkit-playsinline', 'true');
                this.audio.setAttribute('preload', 'auto'); // iOS needs auto for background
                this.audio.crossOrigin = 'anonymous';

                // iOS-specific properties
                try {
                    this.audio.playsInline = true;
                    this.audio.webkitPlaysInline = true;
                    this.audio.preservesPitch = false;
                    this.audio.webkitPreservesPitch = false;
                    this.audio.webkitAudioContext = true;
                    this.audio.webkitAllowsAirPlay = true;
                    
                    if ('webkitAudioSession' in this.audio) {
                        this.audio.webkitAudioSession = 'playback';
                    }
                } catch (error) {
                    console.warn('iOS audio setup failed:', error);
                }

                // iOS-specific pause prevention (very aggressive)
                this.audio.addEventListener('pause', () => {
                    if (!this.audio.ended && this.audio.src && !this.audio.seeking && this.isPlaying) {
                        console.log('üçé iOS pause detected - immediate resume');
                        
                        // Immediate resume (no delay)
                        this.forceIOSResume();
                        
                        // Backup attempts
                        setTimeout(() => this.forceIOSResume(), 100);
                        setTimeout(() => this.forceIOSResume(), 300);
                        setTimeout(() => this.forceIOSResume(), 500);
                    }
                });
            }

            async initializeAudioContext() {
                try {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContextClass();

                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }

                    console.log('üéõÔ∏è iOS AudioContext initialized:', this.audioContext.state);
                } catch (error) {
                    console.error('iOS AudioContext failed:', error);
                }
            }

            async createSilentBuffer() {
                if (!this.audioContext) return;

                try {
                    const sampleRate = this.audioContext.sampleRate;
                    const bufferLength = sampleRate * 1; // 1 second
                    
                    this.silentBuffer = this.audioContext.createBuffer(1, bufferLength, sampleRate);
                    
                    const channelData = this.silentBuffer.getChannelData(0);
                    for (let i = 0; i < bufferLength; i++) {
                        channelData[i] = 0;
                    }
                    
                    console.log('üîá iOS silent buffer created');
                } catch (error) {
                    console.error('Silent buffer creation failed:', error);
                }
            }

            setupIOSEventListeners() {
                // iOS visibility handling
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.isPlaying) {
                        console.log('üçé iOS page hidden - activating background mode');
                        this.activateIOSBackgroundMode();
                    }
                });

                // iOS page lifecycle
                window.addEventListener('pagehide', () => {
                    if (this.isPlaying) {
                        console.log('üçé iOS page hiding - maintaining audio');
                        this.activateIOSBackgroundMode();
                    }
                });

                window.addEventListener('blur', () => {
                    if (this.isPlaying) {
                        console.log('üçé iOS window blur - background mode');
                        this.activateIOSBackgroundMode();
                    }
                });
            }

            forceIOSResume() {
                if (!this.audio || !this.isPlaying) return;

                console.log('üî• Force iOS resume');

                // Resume AudioContext first
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume().catch(() => {});
                }

                // Play audio element
                if (this.audio.paused && !this.audio.ended && this.audio.src) {
                    this.audio.play().catch((error) => {
                        console.warn('iOS resume failed:', error);
                        
                        // Force reload strategy
                        setTimeout(() => {
                            if (this.audio && this.audio.paused && !this.audio.ended && this.isPlaying) {
                                const currentTime = this.audio.currentTime;
                                this.audio.load();
                                this.audio.addEventListener('canplay', () => {
                                    this.audio.currentTime = currentTime;
                                    this.audio.play().catch(() => {});
                                }, { once: true });
                            }
                        }, 200);
                    });
                }
            }

            activateIOSBackgroundMode() {
                if (!this.isPlaying || !this.audioContext) return;

                console.log('üçé Activating iOS background mode');

                // Ensure AudioContext is running
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume().catch(() => {});
                }

                // Connect to Web Audio API
                this.connectToWebAudio();

                // Start silent keep-alive
                this.startSilentKeepAlive();

                // Force audio to continue
                this.forceIOSResume();

                // Start aggressive monitoring
                this.startIOSKeepAlive();
            }

            connectToWebAudio() {
                if (!this.audio || !this.audioContext || this.sourceNode) return;

                try {
                    this.sourceNode = this.audioContext.createMediaElementSource(this.audio);
                    this.gainNode = this.audioContext.createGain();
                    
                    this.sourceNode.connect(this.gainNode);
                    this.gainNode.connect(this.audioContext.destination);
                    
                    console.log('üîó iOS audio connected to Web Audio API');
                } catch (error) {
                    console.warn('Web Audio connection failed:', error);
                }
            }

            startSilentKeepAlive() {
                if (!this.audioContext || !this.silentBuffer) return;

                try {
                    if (this.silentSource) {
                        this.silentSource.stop();
                        this.silentSource.disconnect();
                    }

                    this.silentSource = this.audioContext.createBufferSource();
                    this.silentSource.buffer = this.silentBuffer;
                    this.silentSource.loop = true;
                    
                    const silentGain = this.audioContext.createGain();
                    silentGain.gain.value = 0.001;
                    
                    this.silentSource.connect(silentGain);
                    silentGain.connect(this.audioContext.destination);
                    
                    this.silentSource.start();
                    
                    console.log('üîá iOS silent keep-alive started');
                } catch (error) {
                    console.warn('Silent keep-alive failed:', error);
                }
            }

            startIOSKeepAlive() {
                if (this.keepAliveInterval) return;

                console.log('‚è∞ Starting iOS aggressive keep-alive (2s interval)');

                this.keepAliveInterval = setInterval(() => {
                    if (this.isPlaying && this.audio) {
                        if (this.audio.paused && !this.audio.ended && this.audio.src) {
                            console.log('üö® iOS keep-alive: Audio paused - forcing resume');
                            this.forceIOSResume();
                        }

                        if (this.audioContext && this.audioContext.state === 'suspended') {
                            this.audioContext.resume().catch(() => {});
                        }

                        if (!this.silentSource || this.silentSource.playbackState === 'finished') {
                            this.startSilentKeepAlive();
                        }
                    }
                }, 2000); // Very frequent for iOS
            }

            async setPlaying(playing) {
                this.isPlaying = playing;
                
                if (playing) {
                    this.activateIOSBackgroundMode();
                    this.updateStatus('status', 'iOS Playing', 'success');
                } else {
                    this.stopIOSKeepAlive();
                    this.updateStatus('status', 'iOS Paused', '');
                }
            }

            stopIOSKeepAlive() {
                if (this.keepAliveInterval) {
                    clearInterval(this.keepAliveInterval);
                    this.keepAliveInterval = null;
                }

                if (this.silentSource) {
                    try {
                        this.silentSource.stop();
                        this.silentSource.disconnect();
                        this.silentSource = null;
                    } catch (error) {
                        console.warn('Error stopping silent source:', error);
                    }
                }
            }

            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }

            isAndroid() {
                return /Android/.test(navigator.userAgent);
            }

            updateStatus(elementId, text, className = '') {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                    element.className = className;
                }
            }

            cleanup() {
                this.stopIOSKeepAlive();
                
                if (this.sourceNode) {
                    this.sourceNode.disconnect();
                    this.sourceNode = null;
                }

                if (this.gainNode) {
                    this.gainNode.disconnect();
                    this.gainNode = null;
                }

                if (this.audioContext && this.audioContext.state !== 'closed') {
                    this.audioContext.close().catch(() => {});
                    this.audioContext = null;
                }

                this.audio = null;
                this.isPlaying = false;
                this.updateStatus('status', 'Stopped', '');
                this.updateStatus('backgroundStatus', 'Not Active', '');
            }
        }

        // Initialize test with iOS-specific manager
        const backgroundManager = new IOSTestBackgroundAudioManager();
        const audio = document.getElementById('testAudio');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');

        // Detect and display platform
        const isIOSDevice = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isAndroidDevice = /Android/.test(navigator.userAgent);
        
        let platformText = 'Unknown';
        if (isIOSDevice) platformText = 'iOS';
        else if (isAndroidDevice) platformText = 'Android';
        else platformText = 'Desktop/Other';
        
        document.getElementById('platformStatus').textContent = platformText;
        document.getElementById('platformStatus').className = isIOSDevice ? 'error' : 'success';

        // Test audio URLs - using more reliable sources
        const testAudioUrls = [
            // Short test audio (5 seconds)
            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
            // Longer test audio for background testing
            'https://file-examples.com/storage/fe68c1b7c1a9fd42b4b1f2c/2017/11/file_example_MP3_700KB.mp3',
            // Alternative reliable test audio
            'https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3',
            // Another fallback
            'https://sample-videos.com/zip/10/mp3/mp3-15s/SampleAudio_0.4mb_mp3.mp3'
        ];

        // Initialize
        backgroundManager.initialize(audio);

        // Set up MediaSession for lock screen controls
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'Background Audio Test',
                artist: 'Test App',
                album: 'Test Album',
                artwork: [
                    { src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiBmaWxsPSIjMURCOTU0Ii8+Cjx0ZXh0IHg9IjI1NiIgeT0iMjU2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+VEVTVDwvdGV4dD4KPC9zdmc+', sizes: '512x512', type: 'image/svg+xml' }
                ]
            });

            navigator.mediaSession.setActionHandler('play', () => {
                audio.play();
                backgroundManager.setPlaying(true);
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
            });

            navigator.mediaSession.setActionHandler('pause', () => {
                audio.pause();
                backgroundManager.setPlaying(false);
                startBtn.disabled = false;
                pauseBtn.disabled = true;
            });
        }

        // Button handlers with better error handling
        startBtn.addEventListener('click', async () => {
            let audioStarted = false;
            
            // Try each audio URL until one works
            for (let i = 0; i < testAudioUrls.length && !audioStarted; i++) {
                try {
                    console.log(`Trying audio URL ${i + 1}:`, testAudioUrls[i]);
                    audio.src = testAudioUrls[i];
                    audio.loop = true; // Loop for continuous testing
                    
                    await audio.play();
                    await backgroundManager.setPlaying(true);
                    
                    startBtn.disabled = true;
                    pauseBtn.disabled = false;
                    stopBtn.disabled = false;
                    audioStarted = true;

                    // Set MediaSession state
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.playbackState = 'playing';
                    }
                    
                    console.log('‚úÖ Audio started successfully with URL:', testAudioUrls[i]);
                    
                } catch (error) {
                    console.warn(`‚ùå Failed to start audio with URL ${i + 1}:`, error);
                    if (i === testAudioUrls.length - 1) {
                        // Last URL failed
                        alert('Failed to load any test audio. Please check your internet connection and try again.');
                    }
                }
            }
        });

        pauseBtn.addEventListener('click', () => {
            audio.pause();
            backgroundManager.setPlaying(false);
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;

            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'paused';
            }
        });

        stopBtn.addEventListener('click', () => {
            audio.pause();
            audio.currentTime = 0;
            backgroundManager.cleanup();
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;

            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'none';
            }
        });

        // Handle user interaction requirement
        document.addEventListener('click', () => {
            // Simple user interaction handler - no complex audio context management
            console.log('User interaction detected');
        }, { once: true });

        console.log('Background Audio Test initialized');
        console.log('Platform:', navigator.userAgent);
        console.log('Wake Lock supported:', 'wakeLock' in navigator);
        console.log('MediaSession supported:', 'mediaSession' in navigator);
    </script>
</body>
</html>